# Architecture Decision Record 001

2026-01-27

---

## 1. 배경

ADR-001에서는 MSA 환경에서 사용자 인증 결과를
JWT + RS256 + JWKS 방식으로 표현하고,
각 마이크로 서비스가 토큰을 검증하여 
요청 주체의 정체성을 확보하는 구조를 채택했다.

이 방식은 다음과 같은 장점이 있다.

- 인증 결과의 stateless 전달
- 서비스 간 시크릿 공유 억제
- 공개키 기반 검증을 통한 보안 경계 명확화

그러나 본 프로젝트의 1차 목표는 인증 인프라를 완성하는 것보다,
주문/결제 도메인에서의 동시성 제어, 멱등성, 일관성 문제를 해결해보는 것이다.

이에 따라 ADR 001에 이어서 추가적인 고려가 필요했다.

## 2. 문제 정의

1. Gateway가 없는 초기 MSA 환경에서, 각 마이크로 서비스는 토큰을 어떻게 신뢰할 것인가?
2. 각 서비스가 JWT를 직접 검증할 경우 발생하는 문제들을 어떻게 해소할 수 있을 것인가?
   - JWT 서명 키 관리 및 로테이션
   - 인증 정책 변경 시 서비스 별 재배포 필요성
   - 토큰 즉시 무효의 어려움
3. 인증 책임을 중앙화해도, 서비스가 사용자 DB나 인증 로직을 의존하지 않도록 설계하는 방법

## 3. 고려한 옵션

1. 각 마이크로 서비스가 JWT를 직접 검증 (ADR 001 기본안)
   - 각 서비스가 JWKS를 통해 공개키를 조회
   - 서명, 만료 등을 직접 검증
   
    **장점**
   - Identity 서비스 장애와 무관하게 토큰 검증이 가능함

    **단점**
   - 각 서비스가 JWT 구조와 보안 설정을 알아야함
   - 키 로테이션, 정책 변경 로직이 분산됨
   - 토큰 강제 무효화가 어려움


2. API Gateway 도입 후 Gateway에서 검증
    - Gateway가 JWT 검증
    - 내부 서비스는 인증된 요청만 수신
   
    **장점**
    - 인증 로직이 Gateway 로 밀집됨
    - 각 서비스 구현의 단순화
   
    **단점**
   - Gateway 우회한 요청에 대한 추가 방어 필요함
   - 현재 Gateway를 도입하지 않았음

3. Identity 서비스에 Token Introspection API 추가 **(선택)**
    - 각 마이크로 서비스는 토큰을 직접 해석하지 않음
    - Identity 서비스에 토큰 유효성 검증을 질의
    - 검증 결과만을 기반으로 요청 주체를 식별
> OAuth2 Token Introspection 패턴 적용

## 4. 결정

### 4.1 Identity 서비스에 Token Introspection Endpoint를 추가한다.

Identity 서비스는 ADR 001 문서에서 부여한 책임에 이어서 다음 책임을 추가로 가진다.
- 전달받은 Access Token의 유효성 검증
- 서명, 만료(exp) 검증
- 검증 결과(active/inactive) 반환

Identity 서비스는 내부적으로 `JwtDecoder`를 사용하여 토큰을 검증한다.

### 4.2 각 마이크로 서비스는 인증 검증을 Identity 서비스에 위임한다.

각 마이크로 서비스는 다음을 수행하지 않는다.
- JWT 구조 해석
- 서명 검증
- 키 관리 및 로테이션 처리

대신 다음 절차에 따라서 검증 결과만을 사용한다.
1. 요청에서 Access Token 추출
2. Identity 서비스의 Introspection API 추출
3. 응답 결과 `active` 필드가 `true`인 경우에만 요청 처리
4. `sub` 등 최소한의 claim을 요청 주체 식별자로 사용

이를 통해 서비스를 인증 시스템으로부터 분리할 수 있다.
